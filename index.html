<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Questionnaire System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            line-height: 1.6;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .student-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            font-size: 13px;
        }
        
        .info-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-field label {
            font-weight: bold;
            min-width: 80px;
        }
        
        .info-field input {
            flex: 1;
            border: none;
            border-bottom: 1px solid #000;
            padding: 5px;
            font-family: Arial, sans-serif;
            font-size: 13px;
        }
        
        .directions {
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 30px;
            font-size: 13px;
            line-height: 1.8;
        }
        
        .directions h3 {
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .test-section {
            margin-bottom: 40px;
        }
        
        .section-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #999;
        }
        
        .question-block {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dotted #ddd;
        }
        
        .question-number {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .question-text {
            font-size: 13px;
            margin-bottom: 12px;
            line-height: 1.7;
        }
        
        .question-type-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: bold;
            background-color: #e3f2fd;
            padding: 3px 8px;
            margin-bottom: 8px;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        
        .options {
            margin-left: 20px;
            font-size: 13px;
        }
        
        .option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .option:hover {
            background-color: #f0f0f0;
        }
        
        .option input[type="radio"] {
            margin-top: 2px;
            cursor: pointer;
        }
        
        .option.selected {
            background-color: #e3f2fd;
        }
        
        .upload-section {
            text-align: center;
            padding: 40px;
        }
        
        .upload-box {
            border: 3px dashed #2196f3;
            padding: 40px;
            border-radius: 5px;
            background-color: #f0f8ff;
            margin-bottom: 30px;
        }
        
        .upload-box h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .upload-box p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-button {
            background-color: #2196f3;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            margin-top: 20px;
        }
        
        .upload-button:hover {
            background-color: #1976d2;
        }
        
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .config-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-field label {
            font-weight: bold;
            font-size: 14px;
        }
        
        .config-field input,
        .config-field select,
        .config-field textarea {
            padding: 8px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .config-field textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .checkbox-item input {
            width: auto;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976d2;
        }
        
        .btn-success {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #757575;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .progress-bar {
            background-color: #e0e0e0;
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            background-color: #4caf50;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
            transition: width 0.3s;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .score-box {
            background-color: #f0f0f0;
            border: 2px solid #000;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .score-box .score-number {
            font-size: 28px;
            font-weight: bold;
            color: #2196f3;
            margin-bottom: 10px;
        }
        
        .answer-review {
            border-left: 4px solid #4caf50;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #f1f8f6;
        }
        
        .answer-review.incorrect {
            border-left-color: #f44336;
            background-color: #fef5f4;
        }
        
        .answer-status {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .answer-status.correct {
            color: #4caf50;
        }
        
        .answer-status.incorrect {
            color: #f44336;
        }
        
        .answer-detail {
            font-size: 12px;
            margin-bottom: 5px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 3px;
            margin-bottom: 20px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useRef } = React;
        const { jsPDF } = window.jspdf;

        const SmartQuestionnaireSystem = () => {
            const [uploadedContent, setUploadedContent] = useState('');
            const [fileName, setFileName] = useState('');
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [showResults, setShowResults] = useState(false);
            const [mode, setMode] = useState('upload');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [studentInfo, setStudentInfo] = useState({
                name: '',
                section: '',
                date: new Date().toISOString().split('T')[0]
            });
            const [questionConfig, setQuestionConfig] = useState({
                count: 20,
                difficulty: 'high',
                fontSize: 11,
                testTitle: 'Assessment Test',
                directions: 'Read each question carefully and select the best answer. Mark your answer by filling in the circle completely.',
                types: {
                    scenario: true,
                    analysis: true,
                    evaluation: true,
                    synthesis: true,
                    application: true
                }
            });
            const fileInputRef = useRef(null);

            const parseMarkdown = (content) => {
                const sections = [];
                const lines = content.split('\n');
                let currentSection = { title: '', content: '', level: 0 };
                
                lines.forEach(line => {
                    const headerMatch = line.match(/^(#{1,6})\s+(.+)$/);
                    if (headerMatch) {
                        if (currentSection.content) {
                            sections.push({...currentSection});
                        }
                        currentSection = {
                            title: headerMatch[2],
                            content: '',
                            level: headerMatch[1].length
                        };
                    } else if (line.trim() && !line.startsWith('![')) {
                        currentSection.content += line + '\n';
                    }
                });
                
                if (currentSection.content) {
                    sections.push(currentSection);
                }
                
                return sections.filter(s => s.content.trim().length > 50);
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setFileName(file.name);
                const text = await file.text();
                setUploadedContent(text);
                setMode('generate');
            };

            const generateQuestionsWithAI = async () => {
                if (!apiKey.trim()) {
                    setError('Please enter your Google AI Studio API key');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const sections = parseMarkdown(uploadedContent);
                    const questionTypes = Object.keys(questionConfig.types).filter(
                        type => questionConfig.types[type]
                    );

                    const prompt = `You are an educational assessment expert. Generate ${questionConfig.count} high-quality HOTS (Higher Order Thinking Skills) questions based on the following content.

Content to analyze:
${sections.map(s => `Topic: ${s.title}\n${s.content.substring(0, 500)}`).join('\n\n')}

Requirements:
- Generate exactly ${questionConfig.count} questions
- Difficulty level: ${questionConfig.difficulty}
- Question types to include: ${questionTypes.join(', ')}
- Each question must have: stem (context), question text, 4 options (A-D), correct answer index (0-3), explanation
- Focus on application, analysis, evaluation, and synthesis
- Target higher order thinking skills.
- Make questions scenario-based and realistic

Return ONLY a valid JSON array in this exact format:
[
  {
    "number": 1,
    "type": "scenario",
    "stem": "Context or scenario here",
    "question": "The actual question here",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correctIndex": 0,
    "explanation": "Why this is correct"
  }
]`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate questions. Please check your API key.');
                    }

                    const data = await response.json();
                    const generatedText = data.candidates[0].content.parts[0].text;
                    
                    // Extract JSON from markdown code blocks if present
                    let jsonText = generatedText;
                    const jsonMatch = generatedText.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (jsonMatch) {
                        jsonText = jsonMatch[1];
                    }
                    
                    const generatedQuestions = JSON.parse(jsonText.trim());
                    
                    if (!Array.isArray(generatedQuestions) || generatedQuestions.length === 0) {
                        throw new Error('Invalid response format from AI');
                    }

                    setQuestions(generatedQuestions);
                    setMode('preview');
                    setLoading(false);
                } catch (err) {
                    setError(err.message || 'Failed to generate questions. Please try again.');
                    setLoading(false);
                }
            };

            const downloadPDF = () => {
                const doc = new jsPDF();
                const fontSize = questionConfig.fontSize;
                const lineHeight = fontSize * 0.4;
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const maxWidth = 170;

                // Helper function to add new page if needed
                const checkAndAddPage = (requiredSpace) => {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        doc.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                };

                // Title
                doc.setFontSize(fontSize + 6);
                doc.setFont('helvetica', 'bold');
                doc.text(questionConfig.testTitle, 105, yPosition, { align: 'center' });
                yPosition += lineHeight * 2;

                // Student Info
                doc.setFontSize(fontSize - 1);
                doc.setFont('helvetica', 'normal');
                doc.text('Name: _________________________________', margin, yPosition);
                doc.text(`Date: _____________`, 140, yPosition);
                yPosition += lineHeight * 1.5;
                doc.text('Section: _________________________________', margin, yPosition);
                yPosition += lineHeight * 2;

                // Directions
                if (questionConfig.directions) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('DIRECTIONS:', margin, yPosition);
                    yPosition += lineHeight * 1.2;
                    doc.setFont('helvetica', 'normal');
                    const directionLines = doc.splitTextToSize(questionConfig.directions, maxWidth);
                    directionLines.forEach(line => {
                        checkAndAddPage(lineHeight * 1.2);
                        doc.text(line, margin, yPosition);
                        yPosition += lineHeight * 1.2;
                    });
                    yPosition += lineHeight;
                }

                // Questions
                questions.forEach((q, idx) => {
                    checkAndAddPage(lineHeight * 10);

                    // Question number and type
                    doc.setFontSize(fontSize);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${q.number}. [${q.type.toUpperCase()}]`, margin, yPosition);
                    yPosition += lineHeight * 1.3;

                    // Question stem
                    doc.setFont('helvetica', 'normal');
                    const stemLines = doc.splitTextToSize(q.stem, maxWidth);
                    stemLines.forEach(line => {
                        checkAndAddPage(lineHeight * 1.2);
                        doc.text(line, margin, yPosition);
                        yPosition += lineHeight * 1.2;
                    });
                    yPosition += lineHeight * 0.5;

                    // Question text
                    doc.setFont('helvetica', 'bold');
                    const questionLines = doc.splitTextToSize(q.question, maxWidth);
                    questionLines.forEach(line => {
                        checkAndAddPage(lineHeight * 1.2);
                        doc.text(line, margin, yPosition);
                        yPosition += lineHeight * 1.2;
                    });
                    yPosition += lineHeight * 0.5;

                    // Options
                    doc.setFont('helvetica', 'normal');
                    q.options.forEach((option, optIdx) => {
                        checkAndAddPage(lineHeight * 2);
                        const optionLabel = String.fromCharCode(65 + optIdx);
                        doc.circle(margin + 2, yPosition - 1, 1.5);
                        const optionLines = doc.splitTextToSize(`${optionLabel}. ${option}`, maxWidth - 10);
                        optionLines.forEach((line, lineIdx) => {
                            if (lineIdx > 0) checkAndAddPage(lineHeight * 1.2);
                            doc.text(line, margin + 8, yPosition);
                            yPosition += lineHeight * 1.2;
                        });
                    });
                    yPosition += lineHeight * 1.5;
                });

                doc.save(`${questionConfig.testTitle.replace(/\s+/g, '_')}.pdf`);
            };

            const startOnlineTest = () => {
                setMode('take');
                setCurrentQuestionIndex(0);
                setUserAnswers({});
                setShowResults(false);
            };

            const handleAnswer = (questionIndex, optionIndex) => {
                setUserAnswers({
                    ...userAnswers,
                    [questionIndex]: optionIndex
                });
            };

            const submitQuestionnaire = () => {
                setShowResults(true);
                setMode('results');
            };

            const calculateScore = () => {
                let correct = 0;
                questions.forEach((q, idx) => {
                    if (userAnswers[idx] === q.correctIndex) {
                        correct++;
                    }
                });
                return correct;
            };

            const resetQuestionnaire = () => {
                setQuestions([]);
                setUserAnswers({});
                setShowResults(false);
                setCurrentQuestionIndex(0);
                setMode('upload');
                setUploadedContent('');
                setFileName('');
                setError('');
                setStudentInfo({ name: '', section: '', date: new Date().toISOString().split('T')[0] });
            };

            const exportResults = () => {
                const score = calculateScore();
                const results = {
                    studentName: studentInfo.name,
                    section: studentInfo.section,
                    date: studentInfo.date,
                    fileName,
                    totalQuestions: questions.length,
                    score,
                    percentage: ((score / questions.length) * 100).toFixed(1),
                    answers: questions.map((q, idx) => ({
                        question: q.number,
                        type: q.type,
                        userAnswer: q.options[userAnswers[idx]] || 'Not answered',
                        correctAnswer: q.options[q.correctIndex],
                        isCorrect: userAnswers[idx] === q.correctIndex
                    }))
                };

                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `questionnaire-results-${Date.now()}.json`;
                a.click();
            };

            // UPLOAD MODE
            if (mode === 'upload') {
                return React.createElement('div', { style: { backgroundColor: '#f5f5f5', minHeight: '100vh', padding: '20px' } },
                    React.createElement('div', { className: 'container' },
                        React.createElement('div', { className: 'header' },
                            React.createElement('h1', null, 'Smart Questionnaire Generator')
                        ),
                        React.createElement('div', { className: 'upload-section' },
                            React.createElement('div', { className: 'upload-box' },
                                React.createElement('h2', null, 'Upload Markdown File'),
                                React.createElement('p', null, 'Click to browse or drag and drop your .md, .markdown, or .txt file here'),
                                React.createElement('p', null, 'Supports educational content, lecture notes, study materials, etc.'),
                                React.createElement('button', {
                                    className: 'upload-button',
                                    onClick: () => fileInputRef.current?.click()
                                }, 'Browse Files'),
                                React.createElement('input', {
                                    ref: fileInputRef,
                                    type: 'file',
                                    id: 'fileInput',
                                    accept: '.md,.markdown,.txt',
                                    onChange: handleFileUpload
                                })
                            )
                        )
                    )
                );
            }

            // GENERATE MODE
            if (mode === 'generate') {
                return React.createElement('div', { style: { backgroundColor: '#f5f5f5', minHeight: '100vh', padding: '20px' } },
                    React.createElement('div', { className: 'container' },
                        React.createElement('div', { className: 'header' },
                            React.createElement('h1', null, 'Configure Questionnaire')
                        ),
                        error && React.createElement('div', { className: 'error-message' }, error),
                        React.createElement('div', { style: { marginBottom: '20px', padding: '15px', backgroundColor: '#f0f0f0', border: '1px solid #ccc', borderRadius: '3px' } },
                            React.createElement('p', { style: { fontSize: '13px' } },
                                React.createElement('strong', null, 'Uploaded File: '),
                                fileName
                            )
                        ),
                        React.createElement('div', { className: 'config-field', style: { marginBottom: '20px' } },
                            React.createElement('label', null, 'Google AI Studio API Key:'),
                            React.createElement('input', {
                                type: 'password',
                                placeholder: 'Enter your API key from ai.google.dev',
                                value: apiKey,
                                onChange: (e) => setApiKey(e.target.value)
                            }),
                            React.createElement('p', { style: { fontSize: '11px', color: '#666', marginTop: '5px' } },
                                'Get your free API key at: ',
                                React.createElement('a', { href: 'https://ai.google.dev', target: '_blank' }, 'https://ai.google.dev')
                            )
                        ),
                        React.createElement('div', { className: 'config-section' },
                            React.createElement('div', { className: 'config-field' },
                                React.createElement('label', null, 'Test Title:'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: questionConfig.testTitle,
                                    onChange: (e) => setQuestionConfig({...questionConfig, testTitle: e.target.value})
                                })
                            ),
                            React.createElement('div', { className: 'config-field' },
                                React.createElement('label', null, 'Number of Questions:'),
                                React.createElement('input', {
                                    type: 'number',
                                    min: '5',
                                    max: '100',
                                    value: questionConfig.count,
                                    onChange: (e) => setQuestionConfig({...questionConfig, count: Math.min(100, Math.max(5, parseInt(e.target.value) || 5))})
                                })
                            ),
                            React.createElement('div', { className: 'config-field' },
                                React.createElement('label', null, 'Difficulty Level:'),
                                React.createElement('select', {
                                    value: questionConfig.difficulty,
                                    onChange: (e) => setQuestionConfig({...questionConfig, difficulty: e.target.value})
                                },
                                    React.createElement('option', { value: 'medium' }, 'Medium (Analysis & Application)'),
                                    React.createElement('option', { value: 'high' }, 'High (Evaluation & Synthesis)'),
                                    React.createElement('option', { value: 'mixed' }, 'Mixed (All Levels)')
                                )
                            ),
                            React.createElement('div', { className: 'config-field' },
                                React.createElement('label', null, 'PDF Font Size:'),
                                React.createElement('select', {
                                    value: questionConfig.fontSize,
                                    onChange: (e) => setQuestionConfig({...questionConfig, fontSize: parseInt(e.target.value)})
                                },
                                    React.createElement('option', { value: '9' }, '9pt (Small)'),
                                    React.createElement('option', { value: '10' }, '10pt'),
                                    React.createElement('option', { value: '11' }, '11pt (Recommended)'),
                                    React.createElement('option', { value: '12' }, '12pt (Standard)'),
                                    React.createElement('option', { value: '14' }, '14pt (Large)')
                                )
                            )
                        ),
                        React.createElement('div', { className: 'config-field', style: { gridColumn: '1 / -1' } },
                            React.createElement('label', null, 'Test Directions:'),
                            React.createElement('textarea', {
                                value: questionConfig.directions,
                                onChange: (e) => setQuestionConfig({...questionConfig, directions: e.target.value})
                            })
                        ),
                        React.createElement('div', { className: 'config-field', style: { gridColumn: '1 / -1' } },
                            React.createElement('label', null, 'Question Types (Select at least one):'),
                            React.createElement('div', { className: 'checkboxes' },
                                Object.keys(questionConfig.types).map(type =>
                                    React.createElement('label', { key: type, className: 'checkbox-item' },
                                        React.createElement('input', {
                                            type: 'checkbox',
                                            checked: questionConfig.types[type],
                                            onChange: (e) => setQuestionConfig({
                                                ...questionConfig,
                                                types: {...questionConfig.types, [type]: e.target.checked}
                                            })
                                        }),
                                        React.createElement('span', null, type.charAt(0).toUpperCase() + type.slice(1))
                                    )
                                )
                            )
                        ),
                        loading && React.createElement('div', { className: 'loading' }, 
                            '⏳ Generating questions with AI... This may take a moment.'
                        ),
                        React.createElement('div', { className: 'button-group' },
                            React.createElement('button', {
                                className: 'btn btn-primary',
                                onClick: generateQuestionsWithAI,
                                disabled: !Object.values(questionConfig.types).some(v => v) || loading
                            }, loading ? 'Generating...' : 'Generate Questions with AI'),
                            React.createElement('button', {
